<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>COUNT RAID</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;background:#000;color:#eaffff;
  font-family:system-ui,sans-serif;text-align:center;
}
.card{
  background:#0b0b0b;border:1px solid #00ffcc;
  box-shadow:0 0 20px #00ffcc55;
  padding:20px;border-radius:16px;
  max-width:420px;margin:20px auto;
}
input,button{
  width:100%;padding:12px;margin:6px 0;
  border-radius:10px;border:none;font-size:16px;
}
input{background:#111;color:#fff}
button{background:#00ffcc;color:#000;font-weight:bold}
.hidden{display:none}
.scoreRow{display:flex;justify-content:space-between}
</style>
</head>

<body>

<h1>ğŸ® COUNT RAID</h1>

<!-- LOBBY -->
<div class="card" id="lobby">
  <input id="playerName" placeholder="à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™">
  <input id="roomInput" placeholder="à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡ (à¹€à¸§à¹‰à¸™à¸§à¹ˆà¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¸ªà¸¸à¹ˆà¸¡)">
  <button onclick="createRoom()">à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡</button>
  <button onclick="joinRoom()">à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡</button>
  <div id="roomCode"></div>
</div>

<!-- WAIT -->
<div class="card hidden" id="waiting">
  <h2>â³ à¸£à¸­à¹€à¸à¸·à¹ˆà¸­à¸™</h2>
  <p id="waitingRoomCode"></p>
  <div id="playerList"></div>
  <button id="startBtn" class="hidden" onclick="startGame()">â–¶ï¸ à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡</button>
</div>

<!-- GAME -->
<div class="card hidden" id="game">
  <h3 id="question"></h3>
  <input id="answerInput" placeholder="à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸•à¸­à¸š">
  <button onclick="submitAnswer()">à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸š</button>
  <p id="result"></p>

  <button id="nextBtn" class="hidden" onclick="nextQuestion()">â¡ï¸ à¸‚à¹‰à¸­à¸•à¹ˆà¸­à¹„à¸›</button>
  <button id="restartBtn" class="hidden" onclick="restartGame()">ğŸ”„ à¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸«à¸¡à¹ˆ</button>

  <h3>ğŸ† à¸„à¸°à¹à¸™à¸™</h3>
  <div id="scoreBoard"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, get }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAScwLSlNF1i0cAAT-xadJTFOgGUEsIilk",
  authDomain: "count-raid-game.firebaseapp.com",
  databaseURL: "https://count-raid-game-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "count-raid-game"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== ELEMENT ===== */
const playerNameInput = document.getElementById("playerName");
const roomInput = document.getElementById("roomInput");
const roomCodeDiv = document.getElementById("roomCode");
const lobby = document.getElementById("lobby");
const waiting = document.getElementById("waiting");
const game = document.getElementById("game");
const waitingRoomCode = document.getElementById("waitingRoomCode");
const playerList = document.getElementById("playerList");
const startBtn = document.getElementById("startBtn");
const questionEl = document.getElementById("question");
const answerInput = document.getElementById("answerInput");
const result = document.getElementById("result");
const nextBtn = document.getElementById("nextBtn");
const restartBtn = document.getElementById("restartBtn");
const scoreBoard = document.getElementById("scoreBoard");

/* ===== STATE ===== */
let roomCode="", playerId="", playerName="";
let questions=[
  {q:"à¸¡à¸µà¹€à¸ªà¸·à¹‰à¸­ 3 à¸•à¸±à¸§ à¸à¸²à¸‡à¹€à¸à¸‡ 2 à¸•à¸±à¸§ à¹à¸•à¹ˆà¸‡à¸•à¸±à¸§à¹„à¸”à¹‰à¸à¸µà¹ˆà¹à¸šà¸š",a:6},
  {q:"à¹€à¸£à¸µà¸¢à¸‡ A B C à¹„à¸”à¹‰à¸à¸µà¹ˆà¹à¸šà¸š",a:6},
  {q:"à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸§à¸ 2 à¹ƒà¸š à¸ˆà¸²à¸ 4 à¹ƒà¸š à¹„à¸”à¹‰à¸à¸µà¹ˆà¸§à¸´à¸˜à¸µ",a:6},
  {q:"à¹€à¸¥à¸·à¸­à¸à¸œà¸¥à¹„à¸¡à¹‰ 1 à¸­à¸¢à¹ˆà¸²à¸‡ à¸ˆà¸²à¸ 3 à¸­à¸¢à¹ˆà¸²à¸‡",a:3}
];

/* ===== ROOM ===== */
function randomRoom(){
  return Math.random().toString(36).substring(2,6).toUpperCase();
}

window.createRoom = async ()=>{
  playerName=playerNameInput.value.trim();
  if(!playerName) return alert("à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸à¹ˆà¸­à¸™");
  roomCode=roomInput.value||randomRoom();
  playerId=Date.now().toString();

  await set(ref(db,"rooms/"+roomCode),{
    host:playerId,
    started:false,
    questionIndex:0,
    players:{}
  });

  roomCodeDiv.innerText="à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡: "+roomCode;
  joinRoom(true);
};

window.joinRoom = async (host=false)=>{
  playerName=playerNameInput.value.trim();
  if(!playerName) return alert("à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸à¹ˆà¸­à¸™");
  if(!host){
    roomCode=roomInput.value.toUpperCase();
    playerId=Date.now().toString();
  }

  const roomRef=ref(db,"rooms/"+roomCode);
  const snap=await get(roomRef);
  if(!snap.exists()) return alert("à¹„à¸¡à¹ˆà¸à¸šà¸«à¹‰à¸­à¸‡");

  await update(ref(db,"rooms/"+roomCode+"/players/"+playerId),{
    name:playerName,score:0,answered:false
  });

  lobby.classList.add("hidden");
  waiting.classList.remove("hidden");
  waitingRoomCode.innerText="à¸«à¹‰à¸­à¸‡ "+roomCode;

  onValue(roomRef,s=>{
    const d=s.val();
    renderPlayers(d.players);
    if(playerId===d.host) startBtn.classList.remove("hidden");
    if(d.started) loadQuestion(d);
  });
};

function renderPlayers(players){
  playerList.innerHTML="";
  Object.values(players||{}).forEach(p=>{
    playerList.innerHTML+=`<div>ğŸ‘¤ ${p.name}</div>`;
  });
}

/* ===== GAME ===== */
window.startGame=async()=>{
  await update(ref(db,"rooms/"+roomCode),{
    started:true,
    questionIndex:0
  });
};

function loadQuestion(data){
  waiting.classList.add("hidden");
  game.classList.remove("hidden");

  if(data.questionIndex>=questions.length){
    result.innerText="ğŸ‰ à¸ˆà¸šà¹€à¸à¸¡à¹à¸¥à¹‰à¸§";
    restartBtn.classList.remove("hidden");
    nextBtn.classList.add("hidden");
    return;
  }

  questionEl.innerText=questions[data.questionIndex].q;
  answerInput.value="";
  result.innerText="";
  nextBtn.classList.add("hidden");

  renderScores(data.players);
}

window.submitAnswer=async()=>{
  const val=parseInt(answerInput.value);
  if(isNaN(val)) return;

  const roomRef=ref(db,"rooms/"+roomCode);
  const snap=await get(roomRef);
  const d=snap.val();
  const q=questions[d.questionIndex];

  let delta=val===q.a?10:-5;
  result.innerText=val===q.a?"à¸–à¸¹à¸ +10":"à¸œà¸´à¸” -5 | à¹€à¸‰à¸¥à¸¢ "+q.a;

  const pRef=ref(db,"rooms/"+roomCode+"/players/"+playerId);
  const pSnap=await get(pRef);
  await update(pRef,{score:pSnap.val().score+delta,answered:true});

  if(playerId===d.host) nextBtn.classList.remove("hidden");
};

window.nextQuestion=async()=>{
  await update(ref(db,"rooms/"+roomCode),{
    questionIndex:firebase.database.ServerValue.increment(1)
  });
};

window.restartGame=async()=>{
  await update(ref(db,"rooms/"+roomCode),{
    started:false,
    questionIndex:0
  });
  location.reload();
};

function renderScores(players){
  scoreBoard.innerHTML="";
  Object.values(players||{}).forEach(p=>{
    scoreBoard.innerHTML+=`
      <div class="scoreRow">
        <span>${p.name}</span><b>${p.score}</b>
      </div>`;
  });
}
</script>
</body>
</html>
